<link rel="import" href="../../bower_components/firebase-element/firebase-auth.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../elements/languages/languages-manager.html">


<dom-module id="firebase-login">

	<template>
		<firebase-auth id="auth" provider="password"
					location="https://popping-heat-2481.firebaseio.com/Languages/"
					status-known="{{statusKnown}}"
					user="{{user}}"
					on-error="loginError">
		</firebase-auth>

		<firebase-collection id="usersRef"
                             location="https://popping-heat-2481.firebaseio.com/Users/"
                             data = "{{users}}">
    </firebase-collection>

		<paper-button on-tap="userLogin">USER LOGIN</paper-button>
	
		<h3>Login status:</h3>
        <p>{{computeLoginStatus(statusKnown, user)}}</p>

        <h3>User ID:</h3>
   	    <pre>{{user.uid}}</pre>
   	    <pre>{{authData.google.displayName}}</pre>
   	    <img src="{{authData.google.profileImageURL}}"></img>

   	    <paper-input label="username" id="username"></paper-input>

   	    <paper-input label="password" type="password" id="password"></paper-input>


		<paper-button on-tap="login" raised>ADMIN LOGIN</paper-button>
		<paper-button on-tap="userLogin" raised>USER LOGIN</paper-button>
		<paper-button on-tap="userLoginProva" raised>USER LOGIN PROVA</paper-button>
		<paper-button on-tap="logout" raised>LOGOUT</paper-button>
		<paper-button on-tap="getAuth" raised>GET AUTH</paper-button>


		<languages-manager id="langs">LANGS</languages-manager>


	</template>

	<script>
		Polymer({
			is: "firebase-login",

			properties: {

				statusKnown: {
       	 			type: Boolean,
       	 			notify: true 
      			},
      			user: {
			        type: Object,
			        notify: true, 
			    	observer: '_userChanged'
			        
			    },
			    users: {
			    	type: Object
			    }, 
			    authData: {
			    	type: Object, 

			    }
			},

			  listeners: {
        	  'logged': 'handleLogged',
     	  	 },

     	  	 handleLogged: function(e){
				//console.info('handellato');
     	  	 },

			_userChanged: function(){

				if (this.statusKnown && this.user){

					var ref = new Firebase("https://popping-heat-2481.firebaseio.com/Users");


					var frasi = [{numero: 0}];

					ref.child(ref.getAuth().uid.toString()).set(frasi);


				}
			},

			login: function(){

				var username = this.$.username.value;
				var password = this.$.password.value;

				this.$.auth.login({email: username, password: password});

			}, 

			logout: function(){

				this.$.auth.logout();
			},

			loginError: function(){

				alert("wrong username or password");
			},

			computeLoginStatus: function(statusKnown, user) {
		      if (statusKnown && user) {
		        return 'Logged in';
		      }
		      if (statusKnown) {
		        return 'Logged out';
		      }
		      return 'Unknown (checking status...)';
		    },

		    userLogin: function(){

				var ref = new Firebase("https://popping-heat-2481.firebaseio.com");
				ref.authWithOAuthPopup("google", function(error, authData) {
				  if (error) {
					console.log("Login Failed!", error);
				  } else {
					console.log("Authenticated successfully with payload:", authData.google.displayName);
				  }
				});
		    },

		    userLoginProva: function(){
		    		
				var ref = new Firebase("https://popping-heat-2481.firebaseio.com");
				ref.authWithOAuthPopup("google", function(error, authData) {
				  if (error) {
					console.log("Login Failed!", error);
				  } else {
					//console.log("Authenticated successfully with payload:", authData);
				  }
				}, {scope: "email"});


				ref.onAuth(function(authData) {
				  if (authData) {

					var location = 'https://popping-heat-2481.firebaseio.com/Users/';
					var users = new Firebase(location);

					users.authWithPassword({
					  email    : 'walter.miani@gmail.com',
					  password : 'walter.miani@gmail.com'
					});

					console.log(authData);

					//users.push({name: authData.google.displayName, uid: authData.google.id});

				  } else {
				    console.log("Client unauthenticated.")
				  }
				});
		    },

		    getAuth: function(){
					var location = 'https://popping-heat-2481.firebaseio.com/';
					var ref = new Firebase(location);
					var authData = ref.getAuth();
					console.log(authData);
		    }


		});

	</script>
</dom-module>

	